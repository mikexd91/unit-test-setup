def projectTitle;
def junitPath;
def coveragePath;
def eslintPath;
def rocketchatChannel;

pipeline {
	agent any

	stages {
		
		stage ("install") {
			// execute npm install
			steps {
				echo "SKIP INSTALL";
				//sh 'npm install';
			}
		}

		stage ("NPM Calls") {
			steps {
				parallel (
					populateData: {
						script {
							def data = sh (
								script: 'npm run jenkins',
								returnStdout: true
							).trim().split('\n');

							projectTitle = data[2];
							junitPath = data[3];
							coveragePath = data[4];
							eslintPath = data[5];
							rocketchatChannel = data[6];
						}
					},

					unitTest: {
						script {
							try {
								sh 'npm run test';
							} catch (e) {
								console.log ("Test complete with failures");
							}
						}
					},

					checkstyle: {
						sh 'npm run eslint'
					}
				) 
			}
		}

		stage ("Record Results") {
			steps {
				parallel (
					junit: {
						junit junitPath;
					},

					coverage: {
						step([$class: 'CoberturaPublisher', autoUpdateHealth: false, autoUpdateStability: false, coberturaReportFile: coveragePath, failUnhealthy: false, failUnstable: false, maxNumberOfBuilds: 0, onlyStable: false, sourceEncoding: 'ASCII', zoomCoverageChart: false]);
					},

					checkstyle: {
						checkstyle canComputeNew: false, defaultEncoding: '', healthy: '', pattern: eslintPath, unHealthy: '';
					}
				)
			}
		}

	}

	// post stage
	post {
		always {
			echo "POST ACTION";
		}
		failure {

			echo "FAIL!";
		}
	}
}